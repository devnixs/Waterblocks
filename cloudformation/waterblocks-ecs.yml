AWSTemplateFormatVersion: "2010-09-09"
Description: Waterblocks ECS (Fargate) + RDS (PostgreSQL) with ALB and basic auth for frontend.

Parameters:
  UseExistingVpc:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: "Use an existing VPC and subnets (true/false)."
  ExistingVpcId:
    Type: AWS::EC2::VPC::Id
    Description: "Existing VPC ID (required when UseExistingVpc=true)."
  ExistingSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: "Existing subnet IDs (at least 2, required when UseExistingVpc=true)."
  ApiDomain:
    Type: String
    Description: Hostname for the API (used in ALB host-based routing).
  FrontendDomain:
    Type: String
    Description: Hostname for the Admin UI (used in ALB host-based routing).
  CertificateArn:
    Type: String
    Description: ACM certificate ARN for HTTPS.
  DockerImageRegistryUrl:
    Type: String
    Description: Base registry URL containing waterblocks-api and waterblocks-admin images.
  ApiImageTag:
    Type: String
    Default: latest
    Description: Tag for the waterblocks-api image.
  AdminImageTag:
    Type: String
    Default: latest
    Description: Tag for the waterblocks-admin image.
  PostgresInstanceType:
    Type: String
    Default: db.t4g.micro
    Description: RDS PostgreSQL instance type (default: cheapest in eu-west-1).
  PostgresUsername:
    Type: String
    Default: postgres
    Description: RDS PostgreSQL master username.
  PostgresPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: RDS PostgreSQL master password.
  PostgresDbName:
    Type: String
    Default: waterblocks
    Description: RDS PostgreSQL database name.
  BasicAuthUsername:
    Type: String
    Description: Basic auth username for the Admin UI.
  BasicAuthPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Basic auth password for the Admin UI.
  FrontendApiBaseUrl:
    Type: String
    Default: ""
    Description: Optional API base URL for the Admin UI (defaults to https://ApiDomain).
  FargateCpu:
    Type: String
    Default: "256"
    Description: Fargate task CPU units (256 = 0.25 vCPU).
  FargateMemory:
    Type: String
    Default: "512"
    Description: Fargate task memory in MiB (512 = 0.5 GB).
  VpcCidr:
    Type: String
    Default: 10.20.0.0/16
  PublicSubnet1Cidr:
    Type: String
    Default: 10.20.1.0/24
  PublicSubnet2Cidr:
    Type: String
    Default: 10.20.2.0/24

Conditions:
  UseExistingVpcCondition: !Equals [!Ref UseExistingVpc, "true"]
  CreateVpcCondition: !Equals [!Ref UseExistingVpc, "false"]
  UseCustomFrontendApiBaseUrl: !Not [!Equals [!Ref FrontendApiBaseUrl, ""]]

Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Condition: CreateVpcCondition
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: waterblocks-vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Condition: CreateVpcCondition
    Properties:
      Tags:
        - Key: Name
          Value: waterblocks-igw

  VpcGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: CreateVpcCondition
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Condition: CreateVpcCondition
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: waterblocks-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: CreateVpcCondition
    DependsOn: VpcGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Condition: CreateVpcCondition
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet1Cidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: waterblocks-public-a

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Condition: CreateVpcCondition
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet2Cidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: waterblocks-public-b

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVpcCondition
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVpcCondition
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  AlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ALB security group
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  EcsServiceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ECS tasks security group
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref AlbSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  RdsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS PostgreSQL security group
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref EcsServiceSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Waterblocks DB subnet group
      SubnetIds: !If
        - UseExistingVpcCondition
        - !Ref ExistingSubnetIds
        - - !Ref PublicSubnet1
          - !Ref PublicSubnet2

  DbInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      Engine: postgres
      EngineVersion: "16"
      DBInstanceClass: !Ref PostgresInstanceType
      AllocatedStorage: 20
      DBName: !Ref PostgresDbName
      MasterUsername: !Ref PostgresUsername
      MasterUserPassword: !Ref PostgresPassword
      PubliclyAccessible: false
      VPCSecurityGroups:
        - !Ref RdsSecurityGroup
      DBSubnetGroupName: !Ref DbSubnetGroup
      BackupRetentionPeriod: 0
      DeletionProtection: false

  Alb:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      Subnets: !If
        - UseExistingVpcCondition
        - !Ref ExistingSubnetIds
        - - !Ref PublicSubnet1
          - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref AlbSecurityGroup

  ApiTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      HealthCheckPath: /Health
      HealthCheckIntervalSeconds: 15
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3

  FrontendTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 15
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3

  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref Alb
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: "443"
            StatusCode: HTTP_301

  HttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref Alb
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref CertificateArn
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: "404"
            ContentType: text/plain
            MessageBody: Not Found

  ApiHostRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Ref ApiDomain
      Actions:
        - Type: forward
          TargetGroupArn: !Ref ApiTargetGroup

  FrontendHostRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Ref FrontendDomain
      Actions:
        - Type: forward
          TargetGroupArn: !Ref FrontendTargetGroup

  EcsCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: waterblocks

  EcsTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  ApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/waterblocks-api
      RetentionInDays: 7

  FrontendLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/waterblocks-frontend
      RetentionInDays: 7

  ApiTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: waterblocks-api
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref FargateCpu
      Memory: !Ref FargateMemory
      ExecutionRoleArn: !GetAtt EcsTaskExecutionRole.Arn
      ContainerDefinitions:
        - Name: api
          Image: !Sub "${DockerImageRegistryUrl}/waterblocks-api:${ApiImageTag}"
          Essential: true
          PortMappings:
            - ContainerPort: 8080
          Environment:
            - Name: ASPNETCORE_ENVIRONMENT
              Value: Production
            - Name: ConnectionStrings__DefaultConnection
              Value: !Sub "Host=${DbInstance.Endpoint.Address};Database=${PostgresDbName};Username=${PostgresUsername};Password=${PostgresPassword}"
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref ApiLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  FrontendTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: waterblocks-frontend
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref FargateCpu
      Memory: !Ref FargateMemory
      ExecutionRoleArn: !GetAtt EcsTaskExecutionRole.Arn
      ContainerDefinitions:
        - Name: frontend
          Image: !Sub "${DockerImageRegistryUrl}/waterblocks-admin:${AdminImageTag}"
          Essential: true
          PortMappings:
            - ContainerPort: 80
          Environment:
            - Name: API_BASE_URL
              Value: !If
                - UseCustomFrontendApiBaseUrl
                - !Ref FrontendApiBaseUrl
                - !Sub "https://${ApiDomain}"
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref FrontendLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
        - Name: frontend-auth
          Image: nginx:1.27-alpine
          Essential: true
          DependsOn:
            - ContainerName: frontend
              Condition: START
          PortMappings:
            - ContainerPort: 8080
          Environment:
            - Name: BASIC_AUTH_USERNAME
              Value: !Ref BasicAuthUsername
            - Name: BASIC_AUTH_PASSWORD
              Value: !Ref BasicAuthPassword
          Command:
            - sh
            - -c
            - |
              apk add --no-cache apache2-utils &&
              htpasswd -bc /etc/nginx/.htpasswd "$BASIC_AUTH_USERNAME" "$BASIC_AUTH_PASSWORD" &&
              printf '%s\n' \
                'server {' \
                '  listen 8080;' \
                '  server_name _;' \
                '  location / {' \
                '    auth_basic "Restricted";' \
                '    auth_basic_user_file /etc/nginx/.htpasswd;' \
                '    proxy_set_header Host $host;' \
                '    proxy_set_header X-Forwarded-Proto $scheme;' \
                '    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
                '    proxy_pass http://127.0.0.1:80;' \
                '  }' \
                '}' \
                > /etc/nginx/conf.d/default.conf &&
              nginx -g 'daemon off;'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref FrontendLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  ApiService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpsListener
    Properties:
      ServiceName: waterblocks-api
      Cluster: !Ref EcsCluster
      DesiredCount: 1
      LaunchType: FARGATE
      TaskDefinition: !Ref ApiTaskDefinition
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          Subnets: !If
            - UseExistingVpcCondition
            - !Ref ExistingSubnetIds
            - - !Ref PublicSubnet1
              - !Ref PublicSubnet2
          SecurityGroups:
            - !Ref EcsServiceSecurityGroup
      LoadBalancers:
        - ContainerName: api
          ContainerPort: 8080
          TargetGroupArn: !Ref ApiTargetGroup

  FrontendService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpsListener
    Properties:
      ServiceName: waterblocks-frontend
      Cluster: !Ref EcsCluster
      DesiredCount: 1
      LaunchType: FARGATE
      TaskDefinition: !Ref FrontendTaskDefinition
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          Subnets: !If
            - UseExistingVpcCondition
            - !Ref ExistingSubnetIds
            - - !Ref PublicSubnet1
              - !Ref PublicSubnet2
          SecurityGroups:
            - !Ref EcsServiceSecurityGroup
      LoadBalancers:
        - ContainerName: frontend-auth
          ContainerPort: 8080
          TargetGroupArn: !Ref FrontendTargetGroup

Outputs:
  LoadBalancerDnsName:
    Description: ALB DNS name (create CNAMEs for ApiDomain and FrontendDomain).
    Value: !GetAtt Alb.DNSName
  ApiUrl:
    Description: API URL
    Value: !Sub "https://${ApiDomain}"
  FrontendUrl:
    Description: Frontend URL
    Value: !Sub "https://${FrontendDomain}"
  PostgresEndpoint:
    Description: RDS endpoint address
    Value: !GetAtt DbInstance.Endpoint.Address
